A51 MACRO ASSEMBLER  MOTOR                                                                05/19/2022 22:26:19 PAGE     1


MACRO ASSEMBLER A51 V8.2.7.0
OBJECT MODULE PLACED IN .\Objects\MOTOR.obj
ASSEMBLER INVOKED BY: D:\KEIL\C51\BIN\A51.EXE MOTOR.a51 SET(SMALL) DEBUG PRINT(.\Listings\MOTOR.lst) OBJECT(.\Objects\MO
                      TOR.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     ;SPEED EQU 10H ;SPEED为转速等级标志,共7级,即1~7
                       2     ;FX EQU 11H ;FX 为方向标志
                       3     ;COUNT EQU 12H ;COUNT中断次数标志
                       4     
                       5     ;ORG 0000H
                       6     ;AJMP MAIN
                       7     ;ORG 0003H ;外部中断0入口地址,加速子程序
                       8     ;AJMP UP
                       9     ;ORG 0013H ;外部中断1入口地址,减速子程序
                      10     ;AJMP DOWN
                      11     ;ORG 000BH ;定时器0中断入口地址,控制中断次数来达到控制转速 
                      12     ;AJMP ZDT0
                      13     ;ORG 0030H
                      14     
                      15     ;MAIN: MOV SP,#60H
                      16     ;MOV TMOD,#01H ;工作于定时、软件置位启动,模式1(16 位计时器)
                      17     ;MOV TH0,#0CFH
                      18     ;MOV TL0,#2CH
                      19     ;MOV COUNT,#01H
                      20     ;SETB ET0 ;定时/计数器允许中断
                      21     ;CLR IT0 ;外部中断为电平触发方式,低电平有效
                      22     ;CLR IT1
                      23     ;SETB EX0 ;外部允许中断
                      24     ;SETB EX1
                      25     ;SETB EA ;开总中断
                      26     ;MOV R1,#10000000B ;共阳数码管方向显示8,速度值显示0
                      27     ;MOV R2,#00000001B
                      28     ;MOV SPEED,#00H
                      29     ;MOV FX,#00H
                      30     
                      31     ;XIANS: MOV A,SPEED
                      32     ;MOV DPTR,#LED
                      33     ;MOVC A,@A+DPTR ;查表获取等级对应数码管代码
                      34     ;MOV P2,A ;第二个数码管显示转速等级
                      35     ;MOV A,FX ;准备判断转向
                      36     ;CJNE A,#10000000B,ELS
                      37     ;MOV P0, #0F9H ;第一个数码管显示 1,表示正转
                      38     ;AJMP QD
                      39     
                      40     ;ELS: CJNE A,#00H,ZHENG
                      41     ;MOV P0,#0C0H ;第一个数码管显示 0,表示不转
                      42     ;AJMP QD
                      43     
                      44     ;ZHENG: MOV P0,#0BFH ;第一个数码管显示-,表示反转
                      45     ;QD: JB P3.4,DD ;P3.4 接启动开关 K1,P3.4=1 时启动
                      46     ;CLR TR0 ;停止定时/计数器
                      47     ;MOV P0,#0C0H ;第一个数码管显示 0,表示不转
                      48     ;MOV P2,#0C0H ;第二个数码管显示 0,表示转速为 0
                      49     ;MOV SPEED,#00H ;重新赋初值
                      50     ;MOV FX,#00H
                      51     ;AJMP QD
                      52     ;DD: MOV A,SPEED
                      53     ;JNZ GO ;A 不等于 0,即初始速度不为零,则转移到 GO
                      54     ;CLR TR0 ;停止定时/计数器
                      55     ;AJMP QD
                      56     
                      57     ;GO: SETB TR0 ;开启定时/计数器
A51 MACRO ASSEMBLER  MOTOR                                                                05/19/2022 22:26:19 PAGE     2

                      58     ;;ACALL DELAY
                      59     ;AJMP XIANS
                      60     
                      61     
                      62     ;;以下 ZDT0 为定时器中断程序
                      63     ;ZDT0: 
                      64     ;PUSH ACC
                      65     ;PUSH DPH
                      66     ;PUSH DPL
                      67     ;MOV TL0,#0A4H          ;设置定时初值0.1MS
                      68     ;MOV TH0,#0FFH
                      69     ;DJNZ COUNT,EXIT
                      70     ;JB P3.5,NIZHUAN ;查询方向标志,P3.5 接换向开关 K2
                      71     ;MOV FX,#10000000B
                      72     
                      73     ;NIZHUAN:
                      74     ;MOV A,FX
                      75     ;;CJNE A,#10000000B,FZ ;若A不等于11,即正转,则转移到 FZ
                      76     ;;MOV A,R1 ;R1 记录上一次电机脉冲状态
                      77     ;;MOV P1,A
                      78     ;;RR A ;循环右一位
                      79     ;;MOV R1,A
                      80     ;;MOV P1,A
                      81     ;MOV P1,A
                      82     ;LCALL DELAY1MS
                      83     ;;RL A ;循环左一位
                      84     ;;MOV R1,A
                      85     ;;MOV P1,A
                      86     ;CLR A
                      87     ;MOV P1,A
                      88     ;;AJMP RE
                      89     
                      90     ;;FZ: 
                      91     ;;MOV A,R2
                      92     ;;MOV P2,A
                      93     ;;RL A ;循环左移一位
                      94     ;;MOV P2,A
                      95     ;;MOV R2,A
                      96     ;;MOV P1,A
                      97     ;;LCALL DELAY1MS
                      98     ;;RL A ;循环左右移一位
                      99     ;;MOV P2,A
                     100     ;;MOV R2,A
                     101     ;;CLR A
                     102     ;;MOV P1,A
                     103     
                     104     ;RE: MOV A,SPEED
                     105     ;MOV DPTR,#TAB
                     106     ;MOVC A,@A+DPTR
                     107     ;MOV COUNT,A ;把转速级别赋给 COUNT
                     108     ;JB P3.5 ,FFX ;P3.5 接换向开关K2, 即换向位,若P3.5=1,则跳到 FFX
                     109     ;MOV FX,#10000000B
                     110     ;AJMP EXIT
                     111     
                     112     ;FFX: MOV FX,#00000001B;只要FX不等于10000000B,就可以通过循环左移或右移进
                             换向
                     113     
                     114     ;EXIT: 
                     115     ;POP DPL
                     116     ;POP DPH
                     117     ;POP ACC
                     118     ;RETI
                     119     
                     120     ;;以下 UP 为加速中断程序
                     121     ;UP: PUSH ACC
                     122     ;ACALL DELAY ;延时防抖
A51 MACRO ASSEMBLER  MOTOR                                                                05/19/2022 22:26:19 PAGE     3

                     123     ;JB P3.2,UPEX ;P3.2 为外部中断0位,接增速开关S2,低电平有效,若P3.2=1,则退
                             
                     124     ;MOV A,SPEED
                     125     ;CJNE A,#7,SZ ;最大等级为7,若 A 不等于 7,则转移到 SZ
                     126     ;AJMP UPEX ;若 A=7,则退出
                     127     ;SZ: INC SPEED ;SPEED= SPEED+1
                     128     ;SETB P1.2
                     129     ;UPEX: POP ACC
                     130     ;HERE2: JNB P3.2,HERE2 ;本条指令为防止开关 S2 按下去后弹不起,导致一直
                             生中断
                     131     ;RETI
                     132     
                     133     ;;以下 DOWN 为减速中断程序
                     134     ;DOWN: PUSH ACC
                     135     ;ACALL DELAY
                     136     ;JB P3.3,DEX ;P3.3 为外部中断1位,接减速开关S3,低电平有效,P3.3=1则退出
                     137     ;MOV A,SPEED
                     138     ;CJNE A,#0,SJ
                     139     ;AJMP DEX
                     140     ;SJ: DEC SPEED ;SPEED= SPEED-1
                     141     ;SETB P1.1
                     142     ;DEX: POP ACC
                     143     ;HERE3: JNB P3.3,HERE3
                     144     ;RETI
                     145     
                     146     ;TAB: DB 0,7,6,5,4,3,2,1
                     147     ;LED: DB 0C0H,0F9H,0A4H,0B0H,99H,92H,82H,0F8H,80H,98H
                     148     
                     149     ;DELAY1MS:                      ;@11.0592MHz
                     150             ;PUSH 30H
                     151             ;PUSH 31H
                     152             ;MOV 30H,#9
                     153             ;MOV 31H,#150
                     154     ;NEXT:
                     155             ;DJNZ 31H,NEXT
                     156             ;DJNZ 30H,NEXT
                     157             ;POP 31H
                     158             ;POP 30H
                     159             ;RET
                     160     
                     161     
                     162     ;DELAY: MOV R6,#10 ;延时子程序2.5MS
                     163     ;DEL1: MOV R7,#250
                     164     ;HERE1: DJNZ R7, HERE1
                     165     ;DJNZ R6,DEL1
                     166     ;RET
                     167     
                     168     
                     169     ;END
                     170     
  0011               171         T EQU 11H;中断计数
  0012               172         W EQU 12H;加速次数
0000                 173     ORG 0000H
0000 0130            174     AJMP MAIN
0003                 175     ORG 0003H ;外部中断0入口地址,加速子程序
0003 0186            176     AJMP UP
0013                 177     ORG 0013H ;外部中断1入口地址,减速子程序
0013 01A3            178     AJMP DOWN
000B                 179     ORG 000BH ;定时器0中断入口地址,控占空比来控制电机速度
000B 015A            180     AJMP ZDT0
0030                 181     ORG 0030H
                     182     
0030                 183     MAIN: 
0030 758160          184     MOV SP,#60H
0033 758901          185     MOV TMOD,#01H ;工作于定时、软件置位启动,模式1(16 位计时器)
0036 758CFF          186     MOV TH0,#0FFH
A51 MACRO ASSEMBLER  MOTOR                                                                05/19/2022 22:26:19 PAGE     4

0039 758AF6          187     MOV TL0,#0F6H
003C D2A9            188     SETB ET0 ;定时/计数器允许中断
003E C288            189     CLR IT0 ;外部中断为电平触发方式,低电平有效
0040 C28A            190     CLR IT1
0042 D2A8            191     SETB EX0 ;外部允许中断
0044 D2AA            192     SETB EX1
0046 D2AF            193     SETB EA ;开总中断
0048 751200          194     MOV W,#0
004B 751100          195     MOV T,#0
                     196     
004E                 197     QD: 
004E E512            198     MOV A,W
0050 7004            199     JNZ GO ;A 不等于 0,即初始速度不为零,则转移到 GO
0052 C28C            200     CLR TR0 ;停止定时/计数器
0054 014E            201     AJMP QD
0056 D28C            202     GO: SETB TR0 ;开启定时/计数器
0058 014E            203     AJMP QD
                     204     
                     205     
                     206     ;以下 ZDT0 为定时器中断程序
005A                 207     ZDT0: 
005A C0E0            208     PUSH ACC
005C C083            209     PUSH DPH
005E C082            210     PUSH DPL
0060 758CFF          211     MOV TH0,#0FFH
0063 758AF6          212     MOV TL0,#0F6H
0066 0511            213     INC T
0068 E511            214     MOV A,T
006A B46503          215     CJNE A,#101,PWM
006D 751100          216     MOV T,#0
                     217     
0070                 218     PWM:
0070 E511            219     MOV A,T
0072 C3              220     CLR C
0073 9512            221     SUBB A,W
0075 5005            222     JNC KONG
0077 759080          223     MOV P1,#10000000B
007A 017F            224     AJMP EXIT
007C                 225     KONG:
007C 759000          226     MOV P1,#00000000B
                     227     
007F                 228     EXIT: 
007F D082            229     POP DPL
0081 D083            230     POP DPH
0083 D0E0            231     POP ACC
0085 32              232     RETI
                     233     
                     234     ;以下 UP 为加速中断程序
0086 C0E0            235     UP: PUSH ACC
0088 11BD            236     ACALL DELAY ;延时防抖
008A 20B208          237     JB P3.2,UPEX ;P3.2 为外部中断0位,接增速开关S2,低电平有效,若P3.2=1,则退出
008D E512            238     MOV A,W
008F B46409          239     CJNE A,#100,JIASU
0092 751200          240     MOV W,#0
0095 D0E0            241     UPEX: POP ACC
0097 30B2FD          242     HERE2: JNB P3.2,HERE2 ;本条指令为防止开关 S2 按下去后弹不起,导致一直产
                             生中断
009A 32              243     RETI
009B E512            244     JIASU:MOV A,W
009D 2414            245           ADD A,#20
009F F512            246               MOV W,A
00A1 0195            247               AJMP UPEX
                     248               
                     249               
                     250               
                     251               
A51 MACRO ASSEMBLER  MOTOR                                                                05/19/2022 22:26:19 PAGE     5

                     252               
                     253     
                     254     ;以下 DOWN 为减速中断程序
00A3 C0E0            255     DOWN: PUSH ACC
00A5 11BD            256     ACALL DELAY
00A7 20B305          257     JB P3.3,DEX ;P3.3 为外部中断1位,接减速开关S3,低电平有效,P3.3=1则退出
00AA E512            258     MOV A,W
                     259     ;CJNE A,#0,JIANSU
                     260     ;MOV W,#100
00AC 0200B5          261     LJMP JIANSU
00AF D0E0            262     DEX: POP ACC
00B1 30B3FD          263     HERE3: JNB P3.3,HERE3 ;本条指令为防止开关 S2 按下去后弹不起,导致一直产
                             生中断
00B4 32              264     RETI
00B5 E512            265     JIANSU:MOV A,W
00B7 9414            266           SUBB A,#20
00B9 F512            267               MOV W,A
00BB 01AF            268               AJMP DEX
                     269     
00BD                 270     DELAY:                  ;20MS
00BD C030            271             PUSH 30H
00BF C031            272             PUSH 31H
00C1 7530AD          273             MOV 30H,#173
00C4 75311B          274             MOV 31H,#27
00C7                 275     NEXT:
00C7 D531FD          276             DJNZ 31H,NEXT
00CA D530FA          277             DJNZ 30H,NEXT
00CD D031            278             POP 31H
00CF D030            279             POP 30H
00D1 22              280             RET
                     281     
                     282     
                     283     
                     284     END
A51 MACRO ASSEMBLER  MOTOR                                                                05/19/2022 22:26:19 PAGE     6

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

ACC. . . . . . . .  D ADDR   00E0H   A   
DELAY. . . . . . .  C ADDR   00BDH   A   
DEX. . . . . . . .  C ADDR   00AFH   A   
DOWN . . . . . . .  C ADDR   00A3H   A   
DPH. . . . . . . .  D ADDR   0083H   A   
DPL. . . . . . . .  D ADDR   0082H   A   
EA . . . . . . . .  B ADDR   00A8H.7 A   
ET0. . . . . . . .  B ADDR   00A8H.1 A   
EX0. . . . . . . .  B ADDR   00A8H.0 A   
EX1. . . . . . . .  B ADDR   00A8H.2 A   
EXIT . . . . . . .  C ADDR   007FH   A   
GO . . . . . . . .  C ADDR   0056H   A   
HERE2. . . . . . .  C ADDR   0097H   A   
HERE3. . . . . . .  C ADDR   00B1H   A   
IT0. . . . . . . .  B ADDR   0088H.0 A   
IT1. . . . . . . .  B ADDR   0088H.2 A   
JIANSU . . . . . .  C ADDR   00B5H   A   
JIASU. . . . . . .  C ADDR   009BH   A   
KONG . . . . . . .  C ADDR   007CH   A   
MAIN . . . . . . .  C ADDR   0030H   A   
NEXT . . . . . . .  C ADDR   00C7H   A   
P1 . . . . . . . .  D ADDR   0090H   A   
P3 . . . . . . . .  D ADDR   00B0H   A   
PWM. . . . . . . .  C ADDR   0070H   A   
QD . . . . . . . .  C ADDR   004EH   A   
SP . . . . . . . .  D ADDR   0081H   A   
T. . . . . . . . .  N NUMB   0011H   A   
TH0. . . . . . . .  D ADDR   008CH   A   
TL0. . . . . . . .  D ADDR   008AH   A   
TMOD . . . . . . .  D ADDR   0089H   A   
TR0. . . . . . . .  B ADDR   0088H.4 A   
UP . . . . . . . .  C ADDR   0086H   A   
UPEX . . . . . . .  C ADDR   0095H   A   
W. . . . . . . . .  N NUMB   0012H   A   
ZDT0 . . . . . . .  C ADDR   005AH   A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
