A51 MACRO ASSEMBLER  ____2                                                                05/16/2022 11:47:20 PAGE     1


MACRO ASSEMBLER A51 V8.2.7.0
OBJECT MODULE PLACED IN .\Objects\ӻ2.obj
ASSEMBLER INVOKED BY: D:\KEIL\C51\BIN\A51.EXE ӻ2.a51 SET(SMALL) DEBUG PRINT(.\Listings\ӻ2.lst) OBJECT(.\Objects\
                      2.obj) EP

LOC  OBJ            LINE     SOURCE

  00D5                 1     FLAG BIT F0                  ;  声明传感器复位返回的标志位 
  00B4                 2           DQ BIT P3.4                ;  定义DQ 作为数据传输端口名 
0000                   3           ORG 0000H 
0000 2100              4           AJMP MAIN 
0100                   5           ORG 0100H       
                       6     ;主程序 
0100 12010F            7     MAIN: LCALL RESET              ;  复位 
0103 12012A            8        LCALL FBLCHANGE           ;  改变温度的初始分辨率为9位
0106 120138            9        LCALL GET_TEMP        ;  得到温度
0109 12019C           10        LCALL CHANGE          ;  跳转到数据处理子程序
010C 0201DA           11        LJMP S_INIT
                      12     ;复位程序       
010F D2B4             13     RESET:SETB DQ             ;  总线释放 
0111 00               14        NOP         ;  保持高电平，延时
0112 C2B4             15        CLR DQ             ;  总线置 0，请求响应
0114 78FB             16        MOV R0,#0FBH    
0116 D8FE             17     TSR1: DJNZ R0,TSR1                 ;  延时
0118 D2B4             18        SETB DQ         ;  再释放
011A 7825             19        MOV R0,#25H 
011C 30B402           20     TSR2: JNB DQ,TSR3        ;  改变为 0，则代表得到对应
011F D8FB             21        DJNZ R0,TSR2            ;  未得到则继续等待，判断
0121 D2D5             22     TSR3: SETB FLAG        ;  得到相应则标志位置 1，代表传感器正常存在 
0123 787F             23        MOV R0,#07FH 
0125 D8FE             24     TSR4: DJNZ R0,TSR4                 ;  延时
0127 D2B4             25        SETB DQ         ;  释放总线，完成复位 
0129 22               26     RET 
                      27      
                      28      
                      29     ;改变温度分辨率
012A                  30     FBLCHANGE:
012A 12010F           31        LCALL RESET       ;  复位
012D 74CC             32        MOV A,#0CCH         ;  跳过ROM
012F 120160           33        LCALL WRITE       ;  把A写入传感器
0132 743F             34        MOV A,#3FH          ;  改变温度分辨率为9
0134 120160           35        LCALL WRITE          ;  把A写入传感器
0137 22               36     RET
                      37      
                      38      
                      39     ;得到温度并转换
0138                  40     GET_TEMP:
0138 D2B4             41        SETB DQ        ;  释放总线
013A 12010F           42        LCALL RESET       ;  复位
013D 20D501           43        JB FLAG,TSS2       ;  若传感器不存在，则直接返回主程序
0140 22               44     RET
                      45      
0141 74CC             46     TSS2: MOV A,#0CCH
0143 120160           47        LCALL WRITE       ;  执行跳过ROM指令
0146 7444             48        MOV A,#44H
0148 120160           49        LCALL WRITE         ;  执行测温指令
014B 7BFF             50        MOV R3,#0FFH 
014D DBFE             51        DJNZ R3,$         ;  延时
014F 12010F           52        LCALL RESET            ;  复位
0152 74CC             53        MOV A,#0CCH 
0154 120160           54        LCALL WRITE         ;  执行跳过ROM置零
0157 74BE             55        MOV A,#0BEH 
0159 120160           56        LCALL WRITE         ;  执行读取温度数据指令
015C 120179           57        LCALL READ        ;  跳转至通信子程序
A51 MACRO ASSEMBLER  ____2                                                                05/16/2022 11:47:20 PAGE     2

015F 22               58     RET 
                      59      
                      60      
                      61              
                      62     ;写入数据            ;  不可超过120us，否则无法写入
0160 7A08             63     WRITE:MOV R2,#8        ;  写入八位二进制码，即循环次数
0162 C3               64        CLR C             ;  进位标志位初始置零
0163 C2B4             65     WR1:  CLR DQ         ;  拉低总线为写入做准备
0165 7B05             66        MOV R3,#5
0167 DBFE             67        DJNZ R3,$         ;  延时
0169 13               68        RRC A         ;  A的最低位给CY，使A从低到高写入从机
016A 92B4             69        MOV DQ,C         ;  将A又循环写入C，写入总线以输入到传感器
016C 7B19             70        MOV R3,#25
016E DBFE             71        DJNZ R3,$         ;  延时
0170 D2B4             72        SETB DQ             ;  释放，表示此位写入完毕
0172 00               73        NOP
0173 00               74        NOP   
0174 DAED             75        DJNZ R2,WR1        ;  循环八次，一次写入八位
0176 D2B4             76        SETB DQ             ;  释放总线
0178 22               77     RET 
                      78      
                      79      
                      80     ;读出数据
0179 7C02             81     READ: MOV R4,#2        ;  读取两个八位数据，外层循环次数
017B 7929             82        MOV R1,#29H        ;  立即数寻址给定存储位置
017D 7A08             83     REE0: MOV R2,#8         ;  给定数据位数，是内层循环次数
017F C3               84     REE1: CLR C             ;  进位标志位初始置零
0180 D3               85        SETB C 
0181 00               86        NOP
0182 00               87        NOP 
0183 C2B4             88        CLR DQ 
0185 00               89        NOP 
0186 00               90        NOP 
0187 00               91        NOP
0188 D2B4             92        SETB DQ             ;  输入脉冲并持续2-3个机器周期
018A 7B07             93        MOV R3,#7   
018C DBFE             94        DJNZ R3,$          ;  延时，等待传感器响应
018E A2B4             95        MOV C,DQ          ;  按位读出
0190 7B2D             96        MOV R3,#45
0192 DBFE             97        DJNZ R3,$           ;  延时
0194 13               98        RRC A              ;  把C存入A内
0195 DAE8             99        DJNZ R2,REE1        ;  循环8次
0197 F7              100        MOV @R1,A         ;  存储A
0198 19              101        DEC R1           ;  更换地址
0199 DCE2            102        DJNZ R4,REE0         ;  循环2次
019B 22              103     RET
                     104      
                     105      
                     106             
                     107     ;数据处理函数
019C                 108     CHANGE: 
019C E529            109        MOV A,29H 
019E 852926          110        MOV 26H,29H
01A1 852825          111        MOV 25H,28H 
01A4 852824          112        MOV 24H,28H         ;  在24H存储原始数据防止丢失
01A7 A22F            113        MOV C,25H.7         ;  存储符号位进C
01A9 5014            114        JNC SN1           ;  判断温度的正负，正数则跳过转补码程序
01AB E525            115        MOV A,25H
01AD F4              116        CPL A           ;  取补码，由于无效位置1,25H不必担心数据溢出
01AE F525            117        MOV 25H,A 
01B0 E526            118        MOV A,26H 
01B2 F4              119        CPL A 
01B3 04              120        INC A            ;  由于是末位，需要加一
01B4 F526            121        MOV 26H,A 
01B6 852629          122        MOV 29H,26H 
01B9 852528          123        MOV 28H,25H          ;  在26H，25H中操作后放回29H，28H
A51 MACRO ASSEMBLER  ____2                                                                05/16/2022 11:47:20 PAGE     3

01BC 753001          124        MOV 30H,#01H       ;在30H中保存符号信息
01BF A240            125     SN1:  MOV C,28H.0          ;  正负温度到此均得到整数部分绝对值
01C1 13              126        RRC A 
01C2 A241            127        MOV C,28H.1 
01C4 13              128        RRC A 
01C5 A242            129        MOV C,28H.2 
01C7 13              130        RRC A 
01C8 A243            131        MOV C,28H.3           ;  分别循环，存入A内，连续4次滤掉小数部分
01CA 13              132        RRC A          ;  可分析A内八位恰为整数部分（最高位为0）
01CB 4005            133        JC SL0 
01CD 752700          134        MOV 27H,#00H 
01D0 21D5            135        AJMP SL5 
01D2 752705          136     SL0:  MOV 27H,#05H 
01D5 F529            137     SL5:  MOV 29H,A           ;  为小数部分显示0和5做准备
01D7 F590            138     MOV P1,A
01D9 22              139     RET
                     140     ;LJMP MAIN                    ;  返回主函数，程序执行完毕
                     141     ;从机串口初始化
01DA 7598F0          142     S_INIT: MOV SCON,#0F0H
                     143     ;11110000->5C0N
                     144     ;使能串口收发，并设置工作在模式三
01DD 758920          145     MOV TMOD, #20H
                     146     ;设置定时器11为工作模式2
01E0 758DFD          147     MOV TH1,#0FDH
                     148     ;波特率设置为9600
01E3 758BFD          149     MOV TL1,#0FDH
01E6 D28E            150     SETB TR1
                     151     ;主机发送地址
01E8                 152     CHECK:
01E8 3098FD          153     JNB RI, $
                     154     ;若RI等于0，则继续等待
01EB C298            155     CLR RI
                     156     ;清除接收中断标志RI
01ED E599            157     MOV A,SBUF
                     158     ;接受主机发来的地址信息
01EF B401F6          159     CJNE A, #1,CHECK ;判断发送的地址是否 与本机地址相等，address(这里是1)
                             示本机地址
                     160     ;若不相等则继续等待，不做处理
                     161     
                     162     
01F2 C29D            163     CLR SM2
                     164     ;将SM2位清零
                     165     ;从机应答
                     166     
01F4                 167     ACK0:
01F4 D29B            168     SETB TB8
01F6 759901          169     MOV SBUF,#1;向主机发送应答信号，即发回本机地址(1)给主机
01F9 3099FD          170     JNB TI, $;trasmission
                     171     ;判断发送缓冲区是否为空?
01FC C299            172     CLR TI
                     173     ;清零发送中断标志II
                     174     
01FE                 175     TRASMIT_DATA: 
                     176     ;MOV 29H,#01011101B
01FE E529            177     MOV A,29H;(数据)
0200 F5A0            178     MOV P2,A
0202 A2D0            179     MOV C, P
0204 B3              180     CPL C
0205 92E7            181     MOV ACC.7, C;生成最终要 发送的数据到A
0207 C29B            182     CLR TB8
0209 F599            183     MOV SBUF, A
020B 3099FD          184     JNB TI,$
020E C299            185     CLR TI
                     186     ;清零TB8，使从机进入发送数据状态
0210 C2E7            187     CLR ACC.7
                     188     
A51 MACRO ASSEMBLER  ____2                                                                05/16/2022 11:47:20 PAGE     4

0212                 189     CHECK1:
0212 3098FD          190     JNB RI, $
                     191     ;若RI等于0，则继续等待
0215 C298            192     CLR RI
                     193     ;清除接收中断标志RI
0217 E599            194     MOV A,SBUF
                     195     ;接受主机发来的地址信息
0219 B401F6          196     CJNE A, #1,CHECK1 ;判断发送的地址是否 与本机地址相等，address(这里是1)
                             示本机地址
                     197     ;若不相等则继续等待，不做处理
021C C29D            198     CLR SM2
                     199     ;将SM2位清零
                     200     ;从机应答
                     201     
021E                 202     ACK1:
021E D29B            203     SETB TB8
0220 759901          204     MOV SBUF,#1;向主机发送应答信号，即发回本机地址(1)给主机
0223 3099FD          205     JNB TI, $;trasmission
                     206     ;判断发送缓冲区是否为空?
0226 C299            207     CLR TI
                     208     ;清零发送中断标志II
                     209     
                     210     ;MOV 27,#05H
0228 E527            211     MOV A,27H;(数据)
022A F5A0            212     MOV P2,A
022C A2D0            213     MOV C, P
022E B3              214     CPL C
022F 92E7            215     MOV ACC.7, C;生成最终要 发送的数据到A
0231 C29B            216     CLR TB8
0233 F599            217     MOV SBUF, A
0235 3099FD          218     JNB TI,$
0238 C299            219     CLR TI
                     220     ;清零TB8，使从机进入发送数据状态
023A C2E7            221     CLR ACC.7
                     222     
023C                 223     CHECK2:
023C 3098FD          224     JNB RI, $
                     225     ;若RI等于0，则继续等待
023F C298            226     CLR RI
                     227     ;清除接收中断标志RI
0241 E599            228     MOV A,SBUF
                     229     ;接受主机发来的地址信息
0243 B401F6          230     CJNE A, #1,CHECK2 ;判断发送的地址是否 与本机地址相等，address(这里是1)
                             示本机地址
                     231     ;若不相等则继续等待，不做处理
0246 C29D            232     CLR SM2
                     233     ;将SM2位清零
                     234     ;从机应答
                     235     
0248                 236     ACK2:
0248 D29B            237     SETB TB8
024A 759901          238     MOV SBUF,#1;向主机发送应答信号，即发回本机地址(1)给主机
024D 3099FD          239     JNB TI, $;trasmission
                     240     ;判断发送缓冲区是否为空?
0250 C299            241     CLR TI
                     242     ;清零发送中断标志II
                     243     
                     244     ;MOV 30H,#02H
0252 E530            245     MOV A,30H;(数据)
0254 F5A0            246     MOV P2,A
0256 A2D0            247     MOV C, P
0258 B3              248     CPL C
0259 92E7            249     MOV ACC.7, C;生成最终要 发送的数据到A
025B C29B            250     CLR TB8
025D F599            251     MOV SBUF, A
025F 3099FD          252     JNB TI,$
A51 MACRO ASSEMBLER  ____2                                                                05/16/2022 11:47:20 PAGE     5

0262 C299            253     CLR TI
                     254     ;清零TB8，使从机进入发送数据状态
0264 C2E7            255     CLR ACC.7
                     256     
0266 020100          257     LJMP MAIN
                     258     ;LJMP S_INIT
                     259     END
A51 MACRO ASSEMBLER  ____2                                                                05/16/2022 11:47:20 PAGE     6

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

ACC. . . . . . . .  D ADDR   00E0H   A   
ACK0 . . . . . . .  C ADDR   01F4H   A   
ACK1 . . . . . . .  C ADDR   021EH   A   
ACK2 . . . . . . .  C ADDR   0248H   A   
CHANGE . . . . . .  C ADDR   019CH   A   
CHECK. . . . . . .  C ADDR   01E8H   A   
CHECK1 . . . . . .  C ADDR   0212H   A   
CHECK2 . . . . . .  C ADDR   023CH   A   
DQ . . . . . . . .  B ADDR   00B0H.4 A   
F0 . . . . . . . .  B ADDR   00D0H.5 A   
FBLCHANGE. . . . .  C ADDR   012AH   A   
FLAG . . . . . . .  B ADDR   00D0H.5 A   
GET_TEMP . . . . .  C ADDR   0138H   A   
MAIN . . . . . . .  C ADDR   0100H   A   
P. . . . . . . . .  B ADDR   00D0H.0 A   
P1 . . . . . . . .  D ADDR   0090H   A   
P2 . . . . . . . .  D ADDR   00A0H   A   
P3 . . . . . . . .  D ADDR   00B0H   A   
READ . . . . . . .  C ADDR   0179H   A   
REE0 . . . . . . .  C ADDR   017DH   A   
REE1 . . . . . . .  C ADDR   017FH   A   
RESET. . . . . . .  C ADDR   010FH   A   
RI . . . . . . . .  B ADDR   0098H.0 A   
SBUF . . . . . . .  D ADDR   0099H   A   
SCON . . . . . . .  D ADDR   0098H   A   
SL0. . . . . . . .  C ADDR   01D2H   A   
SL5. . . . . . . .  C ADDR   01D5H   A   
SM2. . . . . . . .  B ADDR   0098H.5 A   
SN1. . . . . . . .  C ADDR   01BFH   A   
S_INIT . . . . . .  C ADDR   01DAH   A   
TB8. . . . . . . .  B ADDR   0098H.3 A   
TH1. . . . . . . .  D ADDR   008DH   A   
TI . . . . . . . .  B ADDR   0098H.1 A   
TL1. . . . . . . .  D ADDR   008BH   A   
TMOD . . . . . . .  D ADDR   0089H   A   
TR1. . . . . . . .  B ADDR   0088H.6 A   
TRASMIT_DATA . . .  C ADDR   01FEH   A   
TSR1 . . . . . . .  C ADDR   0116H   A   
TSR2 . . . . . . .  C ADDR   011CH   A   
TSR3 . . . . . . .  C ADDR   0121H   A   
TSR4 . . . . . . .  C ADDR   0125H   A   
TSS2 . . . . . . .  C ADDR   0141H   A   
WR1. . . . . . . .  C ADDR   0163H   A   
WRITE. . . . . . .  C ADDR   0160H   A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
