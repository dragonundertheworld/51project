A51 MACRO ASSEMBLER  ____1                                                                05/16/2022 11:48:27 PAGE     1


MACRO ASSEMBLER A51 V8.2.7.0
OBJECT MODULE PLACED IN .\Objects\ӻ1.obj
ASSEMBLER INVOKED BY: D:\KEIL\C51\BIN\A51.EXE ӻ1.a51 SET(SMALL) DEBUG PRINT(.\Listings\ӻ1.lst) OBJECT(.\Objects\
                      1.obj) EP

LOC  OBJ            LINE     SOURCE

  00D5                 1     FLAG BIT F0                  ;  声明传感器复位返回的标志位 
  00B4                 2           DQ BIT P3.4                ;  定义DQ 作为数据传输端口名 
0000                   3           ORG 0000H 
0000 2100              4           AJMP MAIN 
0100                   5           ORG 0100H       
                       6     ;主程序 
0100 12010F            7     MAIN: LCALL RESET              ;  复位 
                       8     
0103 12012A            9        LCALL FBLCHANGE           ;  改变温度的初始分辨率为9位
                      10        
0106 120138           11        LCALL GET_TEMP        ;  得到温度
                      12        
0109 12019C           13        LCALL CHANGE          ;  跳转到数据处理子程序
010C 0201DA           14        LJMP S_INIT
                      15     ;复位程序       
010F D2B4             16     RESET:SETB DQ             ;  总线释放 
0111 00               17        NOP         ;  保持高电平，延时
0112 C2B4             18        CLR DQ             ;  总线置 0，请求响应
0114 78FB             19        MOV R0,#0FBH    
0116 D8FE             20     TSR1: DJNZ R0,TSR1                 ;  延时
0118 D2B4             21        SETB DQ         ;  再释放
011A 7825             22        MOV R0,#25H 
011C 30B402           23     TSR2: JNB DQ,TSR3        ;  改变为 0，则代表得到对应
011F D8FB             24        DJNZ R0,TSR2            ;  未得到则继续等待，判断
0121 D2D5             25     TSR3: SETB FLAG        ;  得到相应则标志位置 1，代表传感器正常存在 
0123 787F             26        MOV R0,#07FH 
0125 D8FE             27     TSR4: DJNZ R0,TSR4                 ;  延时
0127 D2B4             28        SETB DQ         ;  释放总线，完成复位 
0129 22               29     RET 
                      30      
                      31      
                      32     ;改变温度分辨率
012A                  33     FBLCHANGE:
012A 12010F           34        LCALL RESET       ;  复位
012D 74CC             35        MOV A,#0CCH         ;  跳过ROM
012F 120160           36        LCALL WRITE       ;  把A写入传感器
0132 743F             37        MOV A,#3FH          ;  改变温度分辨率为9
0134 120160           38        LCALL WRITE          ;  把A写入传感器
0137 22               39     RET
                      40      
                      41      
                      42     ;得到温度并转换
0138                  43     GET_TEMP:
0138 D2B4             44        SETB DQ        ;  释放总线
013A 12010F           45        LCALL RESET       ;  复位
013D 20D501           46        JB FLAG,TSS2       ;  若传感器不存在，则直接返回主程序
0140 22               47     RET
                      48      
0141 74CC             49     TSS2: MOV A,#0CCH
0143 120160           50        LCALL WRITE       ;  执行跳过ROM指令
0146 7444             51        MOV A,#44H
0148 120160           52        LCALL WRITE         ;  执行测温指令
014B 7BFF             53        MOV R3,#0FFH 
014D DBFE             54        DJNZ R3,$         ;  延时
014F 12010F           55        LCALL RESET            ;  复位
0152 74CC             56        MOV A,#0CCH 
0154 120160           57        LCALL WRITE         ;  执行跳过ROM置零
A51 MACRO ASSEMBLER  ____1                                                                05/16/2022 11:48:27 PAGE     2

0157 74BE             58        MOV A,#0BEH 
0159 120160           59        LCALL WRITE         ;  执行读取温度数据指令
015C 120179           60        LCALL READ        ;  跳转至通信子程序
015F 22               61     RET 
                      62      
                      63      
                      64              
                      65     ;写入数据            ;  不可超过120us，否则无法写入
0160 7A08             66     WRITE:MOV R2,#8        ;  写入八位二进制码，即循环次数
0162 C3               67        CLR C             ;  进位标志位初始置零
0163 C2B4             68     WR1:  CLR DQ         ;  拉低总线为写入做准备
0165 7B05             69        MOV R3,#5
0167 DBFE             70        DJNZ R3,$         ;  延时
0169 13               71        RRC A         ;  A的最低位给CY，使A从低到高写入从机
016A 92B4             72        MOV DQ,C         ;  将A又循环写入C，写入总线以输入到传感器
016C 7B19             73        MOV R3,#25
016E DBFE             74        DJNZ R3,$         ;  延时
0170 D2B4             75        SETB DQ             ;  释放，表示此位写入完毕
0172 00               76        NOP
0173 00               77        NOP   
0174 DAED             78        DJNZ R2,WR1        ;  循环八次，一次写入八位
0176 D2B4             79        SETB DQ             ;  释放总线
0178 22               80     RET 
                      81      
                      82      
                      83     ;读出数据
0179 7C02             84     READ: MOV R4,#2        ;  读取两个八位数据，外层循环次数
017B 7929             85        MOV R1,#29H        ;  立即数寻址给定存储位置
017D 7A08             86     REE0: MOV R2,#8         ;  给定数据位数，是内层循环次数
017F C3               87     REE1: CLR C             ;  进位标志位初始置零
0180 D3               88        SETB C 
0181 00               89        NOP
0182 00               90        NOP 
0183 C2B4             91        CLR DQ 
0185 00               92        NOP 
0186 00               93        NOP 
0187 00               94        NOP
0188 D2B4             95        SETB DQ             ;  输入脉冲并持续2-3个机器周期
018A 7B07             96        MOV R3,#7   
018C DBFE             97        DJNZ R3,$          ;  延时，等待传感器响应
018E A2B4             98        MOV C,DQ          ;  按位读出
0190 7B2D             99        MOV R3,#45
0192 DBFE            100        DJNZ R3,$           ;  延时
0194 13              101        RRC A              ;  把C存入A内
0195 DAE8            102        DJNZ R2,REE1        ;  循环8次
0197 F7              103        MOV @R1,A         ;  存储A
0198 19              104        DEC R1           ;  更换地址
0199 DCE2            105        DJNZ R4,REE0         ;  循环2次
019B 22              106     RET
                     107      
                     108      
                     109             
                     110     ;数据处理函数
019C                 111     CHANGE: 
019C E529            112        MOV A,29H 
019E 852926          113        MOV 26H,29H
01A1 852825          114        MOV 25H,28H 
01A4 852824          115        MOV 24H,28H         ;  在24H存储原始数据防止丢失
01A7 A22F            116        MOV C,25H.7         ;  存储符号位进C
01A9 5014            117        JNC SN1           ;  判断温度的正负，正数则跳过转补码程序
01AB E525            118        MOV A,25H
01AD F4              119        CPL A           ;  取补码，由于无效位置1,25H不必担心数据溢出
01AE F525            120        MOV 25H,A 
01B0 E526            121        MOV A,26H 
01B2 F4              122        CPL A 
01B3 04              123        INC A            ;  由于是末位，需要加一
A51 MACRO ASSEMBLER  ____1                                                                05/16/2022 11:48:27 PAGE     3

01B4 F526            124        MOV 26H,A 
01B6 852629          125        MOV 29H,26H 
01B9 852528          126        MOV 28H,25H          ;  在26H，25H中操作后放回29H，28H
01BC 753001          127        MOV 30H,#01H       ;在30H中保存符号信息
01BF A240            128     SN1:  MOV C,28H.0          ;  正负温度到此均得到整数部分绝对值
01C1 13              129        RRC A 
01C2 A241            130        MOV C,28H.1 
01C4 13              131        RRC A 
01C5 A242            132        MOV C,28H.2 
01C7 13              133        RRC A 
01C8 A243            134        MOV C,28H.3           ;  分别循环，存入A内，连续4次滤掉小数部分
01CA 13              135        RRC A          ;  可分析A内八位恰为整数部分（最高位为0）
01CB 4005            136        JC SL0 
01CD 752700          137        MOV 27H,#00H 
01D0 21D5            138        AJMP SL5 
01D2 752705          139     SL0:  MOV 27H,#05H 
01D5 F529            140     SL5:  MOV 29H,A           ;  为小数部分显示0和5做准备
01D7 F590            141     MOV P1,A
01D9 22              142     RET
                     143     
                     144     ;LJMP MAIN                    ;  返回主函数，程序执行完毕
                     145     
                     146     ;从机串口初始化
01DA 7598F0          147     S_INIT: MOV SCON,#0F0H
                     148     ;11110000->5C0N
                     149     ;使能串口收发，并设置工作在模式三
01DD 758920          150     MOV TMOD, #20H
                     151     ;设置定时器11为工作模式2
01E0 758DFD          152     MOV TH1,#0FDH
                     153     ;波特率设置为9600
01E3 758BFD          154     MOV TL1,#0FDH
01E6 D28E            155     SETB TR1
                     156     ;主机发送地址
01E8                 157     CHECK:
01E8 3098FD          158     JNB RI, $
                     159     ;若RI等于0，则继续等待
01EB C298            160     CLR RI
                     161     ;清除接收中断标志RI
01ED E599            162     MOV A,SBUF
                     163     ;接受主机发来的地址信息
01EF B400F6          164     CJNE A, #0,CHECK ;判断发送的地址是否 与本机地址相等，address(这里是1)
                             示本机地址
                     165     ;若不相等则继续等待，不做处理
                     166     
                     167     
01F2 C29D            168     CLR SM2
                     169     ;将SM2位清零
                     170     ;从机应答
                     171     
01F4                 172     ACK0:
01F4 D29B            173     SETB TB8
01F6 759900          174     MOV SBUF,#0;向主机发送应答信号，即发回本机地址(1)给主机
01F9 3099FD          175     JNB TI, $;trasmission
                     176     ;判断发送缓冲区是否为空?
01FC C299            177     CLR TI
                     178     ;清零发送中断标志II
                     179     
01FE                 180     TRASMIT_DATA: 
                     181     ;MOV 29H,#01011101B
01FE E529            182     MOV A,29H;(数据)
0200 F5A0            183     MOV P2,A
0202 A2D0            184     MOV C, P
0204 B3              185     CPL C
0205 92E7            186     MOV ACC.7, C;生成最终要 发送的数据到A
0207 C29B            187     CLR TB8
0209 F599            188     MOV SBUF, A
A51 MACRO ASSEMBLER  ____1                                                                05/16/2022 11:48:27 PAGE     4

020B 3099FD          189     JNB TI,$
020E C299            190     CLR TI
                     191     ;清零TB8，使从机进入发送数据状态
0210 C2E7            192     CLR ACC.7
                     193     
0212                 194     CHECK1:
0212 3098FD          195     JNB RI, $
                     196     ;若RI等于0，则继续等待
0215 C298            197     CLR RI
                     198     ;清除接收中断标志RI
0217 E599            199     MOV A,SBUF
                     200     ;接受主机发来的地址信息
0219 B400F6          201     CJNE A, #0,CHECK1 ;判断发送的地址是否 与本机地址相等，address(这里是1)
                             示本机地址
                     202     ;若不相等则继续等待，不做处理
021C C29D            203     CLR SM2
                     204     ;将SM2位清零
                     205     ;从机应答
                     206     
021E                 207     ACK1:
021E D29B            208     SETB TB8
0220 759900          209     MOV SBUF,#0;向主机发送应答信号，即发回本机地址(1)给主机
0223 3099FD          210     JNB TI, $;trasmission
                     211     ;判断发送缓冲区是否为空?
0226 C299            212     CLR TI
                     213     ;清零发送中断标志II
                     214     
                     215     ;MOV 27,#05H
0228 E527            216     MOV A,27H;(数据)
022A F5A0            217     MOV P2,A
022C A2D0            218     MOV C, P
022E B3              219     CPL C
022F 92E7            220     MOV ACC.7, C;生成最终要 发送的数据到A
0231 C29B            221     CLR TB8
0233 F599            222     MOV SBUF, A
0235 3099FD          223     JNB TI,$
0238 C299            224     CLR TI
                     225     ;清零TB8，使从机进入发送数据状态
023A C2E7            226     CLR ACC.7
                     227     
023C                 228     CHECK2:
023C 3098FD          229     JNB RI, $
                     230     ;若RI等于0，则继续等待
023F C298            231     CLR RI
                     232     ;清除接收中断标志RI
0241 E599            233     MOV A,SBUF
                     234     ;接受主机发来的地址信息
0243 B400F6          235     CJNE A, #0,CHECK2 ;判断发送的地址是否 与本机地址相等，address(这里是1)
                             示本机地址
                     236     ;若不相等则继续等待，不做处理
0246 C29D            237     CLR SM2
                     238     ;将SM2位清零
                     239     ;从机应答
                     240     
0248                 241     ACK2:
0248 D29B            242     SETB TB8
024A 759900          243     MOV SBUF,#0;向主机发送应答信号，即发回本机地址(1)给主机
024D 3099FD          244     JNB TI, $;trasmission
                     245     ;判断发送缓冲区是否为空?
0250 C299            246     CLR TI
                     247     ;清零发送中断标志II
                     248     
                     249     ;MOV 30H,#02H
0252 E530            250     MOV A,30H;(数据)
0254 F5A0            251     MOV P2,A
0256 A2D0            252     MOV C, P
A51 MACRO ASSEMBLER  ____1                                                                05/16/2022 11:48:27 PAGE     5

0258 B3              253     CPL C
0259 92E7            254     MOV ACC.7, C;生成最终要 发送的数据到A
025B C29B            255     CLR TB8
025D F599            256     MOV SBUF, A
025F 3099FD          257     JNB TI,$
0262 C299            258     CLR TI
                     259     ;清零TB8，使从机进入发送数据状态
0264 C2E7            260     CLR ACC.7
                     261     
0266 020100          262     LJMP MAIN
                     263     ;LJMP S_INIT
                     264     END
A51 MACRO ASSEMBLER  ____1                                                                05/16/2022 11:48:27 PAGE     6

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

ACC. . . . . . . .  D ADDR   00E0H   A   
ACK0 . . . . . . .  C ADDR   01F4H   A   
ACK1 . . . . . . .  C ADDR   021EH   A   
ACK2 . . . . . . .  C ADDR   0248H   A   
CHANGE . . . . . .  C ADDR   019CH   A   
CHECK. . . . . . .  C ADDR   01E8H   A   
CHECK1 . . . . . .  C ADDR   0212H   A   
CHECK2 . . . . . .  C ADDR   023CH   A   
DQ . . . . . . . .  B ADDR   00B0H.4 A   
F0 . . . . . . . .  B ADDR   00D0H.5 A   
FBLCHANGE. . . . .  C ADDR   012AH   A   
FLAG . . . . . . .  B ADDR   00D0H.5 A   
GET_TEMP . . . . .  C ADDR   0138H   A   
MAIN . . . . . . .  C ADDR   0100H   A   
P. . . . . . . . .  B ADDR   00D0H.0 A   
P1 . . . . . . . .  D ADDR   0090H   A   
P2 . . . . . . . .  D ADDR   00A0H   A   
P3 . . . . . . . .  D ADDR   00B0H   A   
READ . . . . . . .  C ADDR   0179H   A   
REE0 . . . . . . .  C ADDR   017DH   A   
REE1 . . . . . . .  C ADDR   017FH   A   
RESET. . . . . . .  C ADDR   010FH   A   
RI . . . . . . . .  B ADDR   0098H.0 A   
SBUF . . . . . . .  D ADDR   0099H   A   
SCON . . . . . . .  D ADDR   0098H   A   
SL0. . . . . . . .  C ADDR   01D2H   A   
SL5. . . . . . . .  C ADDR   01D5H   A   
SM2. . . . . . . .  B ADDR   0098H.5 A   
SN1. . . . . . . .  C ADDR   01BFH   A   
S_INIT . . . . . .  C ADDR   01DAH   A   
TB8. . . . . . . .  B ADDR   0098H.3 A   
TH1. . . . . . . .  D ADDR   008DH   A   
TI . . . . . . . .  B ADDR   0098H.1 A   
TL1. . . . . . . .  D ADDR   008BH   A   
TMOD . . . . . . .  D ADDR   0089H   A   
TR1. . . . . . . .  B ADDR   0088H.6 A   
TRASMIT_DATA . . .  C ADDR   01FEH   A   
TSR1 . . . . . . .  C ADDR   0116H   A   
TSR2 . . . . . . .  C ADDR   011CH   A   
TSR3 . . . . . . .  C ADDR   0121H   A   
TSR4 . . . . . . .  C ADDR   0125H   A   
TSS2 . . . . . . .  C ADDR   0141H   A   
WR1. . . . . . . .  C ADDR   0163H   A   
WRITE. . . . . . .  C ADDR   0160H   A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
