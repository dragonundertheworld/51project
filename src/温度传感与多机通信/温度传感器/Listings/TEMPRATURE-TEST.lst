A51 MACRO ASSEMBLER  TEMPRATURE_TEST                                                      05/23/2022 19:54:57 PAGE     1


MACRO ASSEMBLER A51 V8.2.7.0
OBJECT MODULE PLACED IN .\Objects\TEMPRATURE-TEST.obj
ASSEMBLER INVOKED BY: D:\KEIL\C51\BIN\A51.EXE TEMPRATURE-TEST.a51 SET(SMALL) DEBUG PRINT(.\Listings\TEMPRATURE-TEST.lst)
                       OBJECT(.\Objects\TEMPRATURE-TEST.obj) EP

LOC  OBJ            LINE     SOURCE

  00D5                 1      FLAG BIT F0                  ;  声明传感器复位返回的标志位 
  00B4                 2           DQ BIT P3.4                  ;  定义DQ 作为数据传输端口名 
  0035                 3           ABIT EQU 35H                                 ;  个
  0036                 4           BBIT EQU 36H                                 ;  十
  0037                 5           CBIT EQU 37H                 ;  百
0000                   6           ORG 0000H 
0000 2100              7           AJMP MAIN 
0100                   8           ORG 0100H       
                       9     ;主程序 
0100 12010B           10     MAIN: LCALL RESET                  ;  复位 
0103 120126           11               LCALL FBLCHANGE                  ;  改变温度的初始分辨率为9位
0106 120134           12               LCALL GET_TEMP                           ;  得到温度
0109 2196             13               AJMP CHANGE                              ;  跳转到数据处理子程序
                      14     ;复位程序                                   
010B D2B4             15     RESET:SETB DQ                                      ;  总线释放 
010D 00               16               NOP                                              ;  保持高电平，延时
010E C2B4             17               CLR DQ                                   ;  总线置 0，请求响应
0110 78FB             18               MOV R0,#0FBH 
                      19                                                                       
0112 D8FE             20     TSR1: DJNZ R0,TSR1                 ;  延时
0114 D2B4             21               SETB DQ                                          ;  再释放
0116 7825             22               MOV R0,#25H 
0118 30B402           23     TSR2: JNB DQ,TSR3                                  ;  改变为 0，则代表得到对应
011B D8FB             24               DJNZ R0,TSR2                     ;  未得到则继续等待，判断
011D D2D5             25     TSR3: SETB FLAG                                    ;  得到相应则标志位置 1，代
                             传感器正常存在 
011F 786B             26               MOV R0,#06BH 
0121 D8FE             27     TSR4: DJNZ R0,TSR4                 ;  延时
0123 D2B4             28               SETB DQ                                          ;  释放总线，完成复位 
0125 22               29     RET 
                      30      
                      31      
                      32     ;改变温度分辨率
0126                  33     FBLCHANGE:
0126 12010B           34               LCALL RESET                              ;  复位
0129 74CC             35               MOV A,#0CCH                              ;  跳过ROM
012B 12015B           36               LCALL WRITE                              ;  把A写入传感器
012E 741F             37               MOV A,#1FH                           ;  改变温度分辨率为9
0130 12015B           38               LCALL WRITE                          ;  把A写入传感器
0133 22               39     RET
                      40      
                      41      
                      42     ;得到温度并转换
0134                  43     GET_TEMP:
0134 D2B4             44               SETB DQ                                          ;  释放总线
0136 12010B           45               LCALL RESET                              ;  复位
0139 20D501           46               JB FLAG,TSS2                             ;  若传感器不存在，则直接返
                             主程序
013C 22               47     RET
                      48      
013D 74CC             49     TSS2: MOV A,#0CCH
013F 12015B           50               LCALL WRITE                              ;  执行跳过ROM指令
0142 7444             51               MOV A,#44H
0144 12015B           52               LCALL WRITE                              ;  执行测温指令
0147 1201D4           53               LCALL DISPLAY                            ;  不仅延时，还让程序完全生
                             前数码管置零
014A 12010B           54               LCALL RESET                              ;  复位
A51 MACRO ASSEMBLER  TEMPRATURE_TEST                                                      05/23/2022 19:54:57 PAGE     2

014D 74CC             55               MOV A,#0CCH 
014F 12015B           56               LCALL WRITE                              ;  执行跳过ROM置零
0152 74BE             57               MOV A,#0BEH 
0154 12015B           58               LCALL WRITE                              ;  执行读取温度数据指令
0157 120173           59               LCALL READ                               ;  跳转至通信子程序
015A 22               60     RET 
                      61      
                      62      
                      63                                                                             
                      64     ;写入数据                                              ;  不可超过120us，否则无
                             法写入
015B 7A08             65     WRITE:MOV R2,#8                                    ;  写入八位二进制码，即循环
                             数
015D C3               66               CLR C                                        ;  进位标志位初始置零
015E C2B4             67     WR1:  CLR DQ                                       ;  拉低总线为写入做准备
0160 7B06             68               MOV R3,#6 
0162 DBFE             69               DJNZ R3,$                                ;  延时
0164 13               70               RRC A                                            ;  A的最低为给CY，使A从
                             到高写入从机
0165 92B4             71               MOV DQ,C                                 ;  将A又循环写入C，写入总线
                             输入到传感器
0167 7B17             72               MOV R3,#23 
0169 DBFE             73               DJNZ R3,$                                ;  延时
016B D2B4             74               SETB DQ                                          ;  释放，表示此位写入
                             毕
016D 00               75               NOP 
016E DAEE             76               DJNZ R2,WR1                              ;  循环八次，一次写入八位
0170 D2B4             77               SETB DQ                                      ;  释放总线
0172 22               78     RET 
                      79      
                      80      
                      81     ;读出数据
0173 7C02             82     READ: MOV R4,#2                                    ;  读取两个八位数据，外层循
                             次数
0175 7929             83               MOV R1,#29H                              ;  立即数寻址给定存储位置
0177 7A08             84     REE0: MOV R2,#8                                    ;  给定数据位数，是内层循环
                             数
0179 C3               85     REE1: CLR C                                    ;  进位标志位初始置零
017A D3               86               SETB C 
017B 00               87               NOP
017C 00               88               NOP 
017D C2B4             89               CLR DQ 
017F 00               90               NOP 
0180 00               91               NOP 
0181 00               92               NOP 
0182 D2B4             93               SETB DQ                                           ;  输入脉冲并持续2-3个
                             器周期
0184 7B07             94               MOV R3,#7                                
0186 DBFE             95               DJNZ R3,$                                 ;  延时，等待传感器响应
0188 A2B4             96               MOV C,DQ                                  ;  按位读出
018A 7B17             97               MOV R3,#23
018C DBFE             98               DJNZ R3,$                                 ;  延时
018E 13               99               RRC A                                             ;  把C存入A内
018F DAE8            100               DJNZ R2,REE1                              ;  循环8次
0191 F7              101               MOV @R1,A                                 ;  存储A
0192 19              102               DEC R1                                            ;  更换地址
0193 DCE2            103               DJNZ R4,REE0                              ;  循环2次
0195 22              104     RET
                     105      
                     106      
                     107                                                                             
                     108     ;数据处理函数
0196                 109     CHANGE: 
0196 E529            110               MOV A,29H 
0198 852926          111               MOV 26H,29H
019B 852825          112               MOV 25H,28H 
A51 MACRO ASSEMBLER  TEMPRATURE_TEST                                                      05/23/2022 19:54:57 PAGE     3

019E 852824          113               MOV 24H,28H                               ;  在24H存储原始数据防止丢失
01A1 A22F            114               MOV C,25H.7                               ;  存储符号位进C
01A3 5011            115               JNC SN1                                           ;  判断温度的正负，正
                             则跳过转补码程序
01A5 E525            116               MOV A,25H
01A7 F4              117               CPL A                                         ;  取补码，由于无效位置1,
                             25H不必担心数据溢出
01A8 F525            118               MOV 25H,A 
01AA E526            119               MOV A,26H 
01AC F4              120               CPL A 
01AD 04              121               INC A                                              ;  由于是末位，需要加
                             一
01AE F526            122               MOV 26H,A 
01B0 852629          123               MOV 29H,26H 
01B3 852528          124               MOV 28H,25H                                ;  在26H，25H中操作后放回29H
                             28H
01B6 A240            125     SN1:  MOV C,28H.0                                    ;  正负温度到此均得到整数
                             分绝对值
01B8 13              126               RRC A 
01B9 A241            127               MOV C,28H.1 
01BB 13              128               RRC A 
01BC A242            129               MOV C,28H.2 
01BE 13              130               RRC A 
01BF A243            131               MOV C,28H.3                                 ;  分别循环，存入A内，连续
                             4次滤掉小数部分
01C1 13              132               RRC A                                                   ;  可分析A内八位恰
                             为整数部分（最高位为0）
01C2 4005            133               JC SL0 
01C4 752700          134               MOV 27H,#00H 
01C7 21CC            135               AJMP SL5 
01C9 752705          136     SL0:  MOV 27H,#05H 
01CC F529            137     SL5:  MOV 29H,A                                       ;  为小数部分显示0和5做准备
01CE 1201D4          138               LCALL DISPLAY                                   ;  转入显示函数
01D1 020100          139     LJMP MAIN                                             ;  返回主函数，程序执行完
                             
                     140      
                     141      
                     142     ;显示函数
01D4                 143     DISPLAY:
01D4 E529            144               MOV A,29H 
01D6 75F00A          145               MOV B,#10 
01D9 84              146               DIV AB 
01DA 85F035          147               MOV ABIT,B 
01DD 75F00A          148               MOV B,#10 
01E0 84              149               DIV AB 
01E1 85F036          150               MOV BBIT,B 
                     151                                                                             
01E4 F537            152          MOV CBIT,A                                       ;  此时可知CBA即为百十个位
01E6 7804            153               MOV R0,#4  
01E8 75A021          154               MOV P2,#21H                                     ;  循环显示
01EB 79FA            155     DIS0: MOV R1,#250                                     ;  长时间延时循环
01ED A227            156     DIS1: MOV C,24H.7 
01EF 5012            157               JNC DIS2                                                ;  正数转移，负数
                             续
01F1 780E            158               MOV R0,#0EH                                     
01F3 D2A1            159               SETB P2.1
01F5 E8              160               MOV A,R0
01F6 F580            161               MOV P0,A
01F8 C2A1            162               CLR P2.1
01FA 7440            163               MOV A,#40H
01FC F580            164               MOV P0,A 
01FE 12024D          165               LCALL DELAY 
0201 4113            166               AJMP DIS3
0203 780E            167     DIS2: MOV R0,#0EH   
0205 D2A1            168               SETB P2.1 
0207 E8              169               MOV A,R0
A51 MACRO ASSEMBLER  TEMPRATURE_TEST                                                      05/23/2022 19:54:57 PAGE     4

0208 F580            170               MOV P0,A
020A C2A1            171               CLR P2.1 
020C 7400            172               MOV A,#00H
020E F580            173               MOV P0,A
0210 12024D          174               LCALL DELAY                                     ;  符号位判断显示
0213 E527            175     DIS3: MOV A,27H                                           ;  显示小数
0215 900256          176               MOV DPTR,#TAB
0218 93              177               MOVC A,@A+DPTR 
0219 7807            178               MOV R0,#07H
021B D2A1            179               SETB P2.1
021D 8880            180               MOV P0,R0 
021F C2A1            181               CLR P2.1
0221 F580            182               MOV P0,A  
0223 12024D          183               LCALL DELAY                                     ;  小数位判断显示
0226 E535            184     DIS4: MOV A,ABIT                                          ;显示个位
0228 900260          185               MOV DPTR,#TAB1
022B 93              186               MOVC A,@A+DPTR 
022C 780B            187               MOV R0,#0BH 
022E D2A1            188               SETB P2.1
0230 8880            189               MOV P0,R0
0232 C2A1            190               CLR P2.1
0234 F580            191               MOV P0,A  
0236 12024D          192               LCALL DELAY 
0239 E536            193     DIS5: MOV A,BBIT                                          ;显示十位
023B 900256          194               MOV DPTR,#TAB
                     195                                                                             
023E 93              196               MOVC A,@A+DPTR
023F 780D            197               MOV R0,#0DH
0241 D2A1            198               SETB P2.1
0243 8880            199           MOV P0,R0
0245 C2A1            200               CLR P2.1 
0247 F580            201               MOV P0,A  
0249 12024D          202               LCALL DELAY                                            
024C 22              203     RET 
                     204      
                     205      
                     206     ;延迟函数
024D 7D08            207     DELAY:  MOV R5,#08H
024F 7EFA            208     DD:             MOV R6,#0FAH
0251 DEFE            209                     DJNZ R6,$
0253 DDFA            210                     DJNZ R5,DD
0255 22              211                     RET
                     212      
0256                 213     TAB:                                                              ;  共阴极数码管0-9
0256 3F065B4F        214               DB  3FH,06H,5BH,4FH,66H,6DH,7DH,07H,7FH,6FH
025A 666D7D07                
025E 7F6F                    
0260                 215     TAB1:                                                             ;  带小数点的个位
                             示数码0-9
0260 BF86DBCF        216               DB  0BFH,86H,0DBH,0CFH,0E6H,0EDH,0FDH,87H,0FFH,0EFH
0264 E6EDFD87                
0268 FFEF                    
                     217      
                     218      
026A                 219     LOOP:
026A 80FE            220               JMP LOOP ;
                     221     END
A51 MACRO ASSEMBLER  TEMPRATURE_TEST                                                      05/23/2022 19:54:57 PAGE     5

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

ABIT . . . . . . .  N NUMB   0035H   A   
B. . . . . . . . .  D ADDR   00F0H   A   
BBIT . . . . . . .  N NUMB   0036H   A   
CBIT . . . . . . .  N NUMB   0037H   A   
CHANGE . . . . . .  C ADDR   0196H   A   
DD . . . . . . . .  C ADDR   024FH   A   
DELAY. . . . . . .  C ADDR   024DH   A   
DIS0 . . . . . . .  C ADDR   01EBH   A   
DIS1 . . . . . . .  C ADDR   01EDH   A   
DIS2 . . . . . . .  C ADDR   0203H   A   
DIS3 . . . . . . .  C ADDR   0213H   A   
DIS4 . . . . . . .  C ADDR   0226H   A   
DIS5 . . . . . . .  C ADDR   0239H   A   
DISPLAY. . . . . .  C ADDR   01D4H   A   
DQ . . . . . . . .  B ADDR   00B0H.4 A   
F0 . . . . . . . .  B ADDR   00D0H.5 A   
FBLCHANGE. . . . .  C ADDR   0126H   A   
FLAG . . . . . . .  B ADDR   00D0H.5 A   
GET_TEMP . . . . .  C ADDR   0134H   A   
LOOP . . . . . . .  C ADDR   026AH   A   
MAIN . . . . . . .  C ADDR   0100H   A   
P0 . . . . . . . .  D ADDR   0080H   A   
P2 . . . . . . . .  D ADDR   00A0H   A   
P3 . . . . . . . .  D ADDR   00B0H   A   
READ . . . . . . .  C ADDR   0173H   A   
REE0 . . . . . . .  C ADDR   0177H   A   
REE1 . . . . . . .  C ADDR   0179H   A   
RESET. . . . . . .  C ADDR   010BH   A   
SL0. . . . . . . .  C ADDR   01C9H   A   
SL5. . . . . . . .  C ADDR   01CCH   A   
SN1. . . . . . . .  C ADDR   01B6H   A   
TAB. . . . . . . .  C ADDR   0256H   A   
TAB1 . . . . . . .  C ADDR   0260H   A   
TSR1 . . . . . . .  C ADDR   0112H   A   
TSR2 . . . . . . .  C ADDR   0118H   A   
TSR3 . . . . . . .  C ADDR   011DH   A   
TSR4 . . . . . . .  C ADDR   0121H   A   
TSS2 . . . . . . .  C ADDR   013DH   A   
WR1. . . . . . . .  C ADDR   015EH   A   
WRITE. . . . . . .  C ADDR   015BH   A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
