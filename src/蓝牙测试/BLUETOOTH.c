#include<reg52.h>
#define uint  unsigned int
#define uchar unsigned char
unsigned char DataGet;
unsigned int flag1=0;
unsigned int flag2=0;
void SendData(unsigned char c);
void ReceiveData();
unsigned int Tstrcmp(unsigned char *str1, unsigned char *str2 );

/*初始化子程序*/
void Init()
{
	//定时器0初始化
	TMOD=0x20;//M1:M0=10 定时器0工作方式2, 可重置8位
	
	IT1=0;//低电平
	ET1=0;//中断允许
	TR1=1;//开启定时器计数
	
	TH1=0xfd;
	TL1=0xfd;//设置定时器初值
//	TH1=0xFF;
//	TL1=0xE8;
	PCON=0x00;//SCON=0
	
	//串口初始化
	SM0=0;
	SM1=1;//串口工作方式1 8位UART
	REN=1;//使能串行接收
	ES=1;//串口中断允许
	EA=1;//开启总中断允许位
	
//  SCON = 0x50;		//8位数据,可变波特率
//	AUXR &= 0xBF;		//定时器1时钟为Fosc/12,即12T
//	AUXR &= 0xFE;		//串口1选择定时器1为波特率发生器
//	TMOD &= 0x0F;		//设定定时器1为16位自动重装方式
//	TL1 = 0xE8;		//设定定时初值
//	TH1 = 0xFF;		//设定定时初值
//	ET1 = 0;		//禁止定时器1中断
//	TR1 = 1;		//启动定时器1

}

/*数据发送子函数*/
void SendData(int humidity)
{	int i=0;
	unsigned char gewei,shiwei,array1[]={"HUMIDITY:  "};
	gewei=humidity%10+'0';
	shiwei=humidity/10+'0';
	array1[9]=shiwei;
	array1[10]=gewei;

	while(array1[i] != '\0')
	{	
		SBUF=array1[i];
		while(!TI);//若没有发送完数据 等待
		TI=0;//若发送完 标志位清0
		i++;
	}

}

/*数据接收子函数*/

void ReceiveData()
{	
	
	
	//若发送完 标志位清0
}
/*串口收发中断服务程序
触发串口中断的是发送中断
或者是接收中断*/


//单片机字符串比较
unsigned int Tstrcmp(unsigned char *str1, unsigned char *str2 )
{
	
	while(1)
	{
		
		if(*str1!=*str2)
			return 1;//不相等
    if(*str1=='\0')
			break;//对比完成了.
    str1++;
    str2++;
	}
	return 0;
	
}
/*主函数*/
void main()
{int humidity;
	humidity=65;
	P1=0x55;
	Init();
	SendData(humidity);
	ReceiveData();
	while(1)
		{
		  
		}
}
void SeriesInterrupt() interrupt 4
{	
	/*if(TI)//发送完毕 发送中断位TI置1
	{
		TI=0;
	}*/
	EA=0;
	if(RI)//接收完毕 接收中断位RI置1
	{ DataGet = SBUF;  //??????48???????????з??????????????ASCII??
  
		RI=0;
		//DataGet=SBUF;//取出接收的数据
		
//		if(DataGet=="ON")
//		{
//			//SendData(DataGet);//将接收的数据发送出去
//			P1=0x00;
//		}
//		else
//		{
//			P1=0xFF;
//			
//		}
		SendData(DataGet);//将接收的数据发送出去
//		flag1=Tstrcmp(DataGet, "Y");
//		flag2=Tstrcmp(DataGet, "N");
		if(DataGet=='Y')
			P1=0x00;//开灯
		else if(DataGet=='N')
			P1=0xFF;//关灯
		else
			P1=0x55;//交替
	}
	EA=1;
}



//--------------------------------------------------------------------------------------------------------------------------------------
//#include<reg52.h>
//#include<intrins.h>

//#define uchar unsigned char
//#define uint  unsigned int

//uchar uart_receive_buffer[30];  //?????????????
//uchar uart_receive_number=0;    //????????????


///********************************************************************
//* ???? : Delay_1ms()
//* ???? : ??????????????? 1ms
//* x * ???? : x (????????????)
//* ??? : ??
//***********************************************************************/
//void Delay_1ms(uint i)//1ms???
//{
//  uchar x,j;
//  
//  for(j=0;j<i;j++)
//    for(x=0;x<=148;x++);
//}

///********************************************************************
//* ???? : Com_Int()
//* ???? : ?????ж??????
//* ???? : ?? * ??? : ??
//***********************************************************************/
//void Com_Int(void) interrupt 4
//{
//  static uchar i = 7;  //???????????????????????????????? i ????????????
//  Delay_1ms(10);
//  EA = 0;
//  if(RI == 1){  //????????????????????RI????λ
//    RI = 0;
//    uart_receive_buffer[uart_receive_number] = SBUF;  //??????48???????????з??????????????ASCII??
//    uart_receive_number++;
//  }
//  EA = 1;
//}

///********************************************************************
//* ???? : Com_Init()
//* ???? : ??????????????11.0592,??????9600???????????ж?
//* ???? : ??
//* ??? : ??
//***********************************************************************/
//void Com_Init(void) {
//  TMOD = 0x20;
//  PCON = 0x00;
//  SCON = 0x50;
//  TH1 = 0xFd;  //???ò????? 9600
//  TL1 = 0xFd;
//  TR1 = 1;  //?????????1
//  ES = 1;  //???????ж?
//  EA = 1;  //?????ж?
//}

///********************************************************************
//* ???? : Main()
//* ???? : ??????
//* ???? : ??
//* ??? : ??
//***********************************************************************/
//void Main()
//{
//  uchar uart_receive_number_old=0;
//  
//  Com_Init();
//  P1=0x55;
//	
//  while(1){
//    
//    if(uart_receive_number_old!=uart_receive_number){
//      uart_receive_number_old=uart_receive_number;
//			P1=0x00;//开灯

//    }
//    
//    //????????????????????1??????????????????????????ж????
//    //???д????????????????????????????????????????
//    Delay_1ms(30);
//    
//    //?????????????????????λ??????????????????
//    if(uart_receive_number_old==uart_receive_number){
//			P1=0xFF;//关灯
//      if(uart_receive_number)
//        break;
//    }
//  }
//  
//  if(uart_receive_number){
//    //?????????????????Щ??????????
//  }
//  
//  while(1);
//}

